# Security Patterns for Future AI Agents

Generated: 2025-07-19T11:48:43.026Z

This document provides security patterns and best practices for future AI agents working on RLS policy development.

## 🛡️ Secure Policy Development

Patterns for developing new RLS policies with security best practices

### Template
```sql

          -- ✅ SECURE RLS Policy Development Pattern
          -- Follow this pattern when creating new policies to ensure security
          
          -- 1. Always test with multiple user contexts
          -- 2. Verify users can only access their own data
          -- 3. Test role-based access controls
          -- 4. Validate insert/update restrictions
          
          CREATE POLICY "secure_policy_name" ON "table_name"
          AS PERMISSIVE FOR SELECT
          TO authenticated
          USING (
            -- ✅ GOOD: User can only see their own records
            user_id = (SELECT auth.uid())
            
            -- ✅ GOOD: Or admin can see all records
            OR ((SELECT auth.jwt()) ->> 'role') = 'admin'
            
            -- ✅ GOOD: Or manager can see team records
            OR (
              ((SELECT auth.jwt()) ->> 'role') = 'manager'
              AND team_id IN (
                SELECT team_id FROM team_members 
                WHERE user_id = (SELECT auth.uid())
              )
            )
          );
        
```

### Security Tests
```sql

          -- Security Test Template for New Policies
          DO $$
          DECLARE
            test_user_1 UUID := gen_random_uuid();
            test_user_2 UUID := gen_random_uuid();
            admin_user UUID := gen_random_uuid();
          BEGIN
            -- Test 1: User isolation
            SET request.jwt.claims TO json_build_object('sub', test_user_1, 'role', 'authenticated')::text;
            -- Verify user can only see their own data
            
            -- Test 2: Admin access
            SET request.jwt.claims TO json_build_object('sub', admin_user, 'role', 'admin')::text;
            -- Verify admin can see appropriate data
            
            -- Test 3: Cross-user access prevention
            SET request.jwt.claims TO json_build_object('sub', test_user_1, 'role', 'authenticated')::text;
            -- Verify user cannot see other users' data
          END $$;
        
```

## 🧪 Security Testing Workflow

Workflow for testing security of new or modified policies

### Steps:
- Create test users with different roles
- Test data access for each role
- Verify users cannot access unauthorized data
- Test insert/update/delete permissions
- Validate role hierarchy works correctly
- Run regression tests after changes

## 📊 Security Monitoring

Ongoing security monitoring for RLS policies

### Monitoring Queries
```sql

          -- Daily Security Health Check
          SELECT 
            COUNT(*) as total_policies,
            COUNT(CASE WHEN qual IS NULL AND with_check IS NULL THEN 1 END) as unrestricted_policies,
            COUNT(CASE WHEN qual LIKE '%auth.uid()%' OR qual LIKE '%auth.jwt()%' THEN 1 END) as auth_policies
          FROM pg_policies 
          WHERE schemaname = 'public';
        
```

---
*Generated by Security Preservation Verification System*