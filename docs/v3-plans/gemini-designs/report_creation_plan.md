## Report Creation & Management System Design (Refined for PDF Generation)

### **1. Core Objectives**

*   Enable users to create detailed, structured reports line-by-line.
*   Support text descriptions and image uploads for each report line.
*   Provide a review step before finalization.
*   Generate a professional PDF version of the report.
*   Allow selective publishing and notification to internal and/or client stakeholders.
*   Maintain a clear historical record of all reports for each project.

### **2. Workflow Breakdown (User Journey)**

1.  **Access Report Creation:**
    *   From the "Project Management Workspace" (`/projects/[id]`), navigate to the (new) "Reports" section (which will replace the old `ReportsTab.tsx`).
    *   Click a prominent "Create New Report" button.

2.  **Report Header Information:**
    *   **Report Name:** Input field for a custom name (e.g., "Daily Report - 2024-07-08").
    *   **Report Type (Dropdown):** Select from predefined types (e.g., "Daily Report," "Weekly Progress," "Safety Inspection," "Quality Check," "Custom"). This can pre-populate some fields or influence PDF template.
    *   **Project Association:** Automatically linked to the current project.
    *   **Generated By:** Automatically populated with the current user.
    *   **Generated Date:** Automatically populated with the current date.
    *   *(Optional: Report Period, Summary - if desired for the overall report)*

3.  **Line-by-Line Content Creation (Iterative Form):**
    *   **Line Name/Title:** Input field (e.g., "Foundation Work," "HVAC Installation," "Safety Observation").
    *   **Description:** Rich text editor or large textarea for detailed notes.
    *   **Photos:** "Upload Photos" button/area. Allows multiple image uploads per line. Display thumbnails of uploaded images.
    *   **Action Button:** "Save Line & Add Next"
        *   Saves the current line's data to the database.
        *   Clears the form fields and presents a new, empty form for the next line.
        *   Displays a summary of previously added lines (e.g., a list of line titles) for easy navigation/editing.
    *   **Navigation:** "Previous Line" button to go back and edit.

4.  **Review & Finalize:**
    *   **"Review Report" Button:** After adding all lines, click this.
    *   Displays a consolidated view of the entire report (all lines, descriptions, photos).
    *   Allows for final edits to any line or the overall report details.
    *   **"Generate PDF" Button:** Triggers the PDF generation process.

5.  **Publish & Notify:**
    *   **"Publish Report" Button:** Becomes active after PDF generation.
    *   **Sharing Options (Modal/Sidebar):**
        *   Checkboxes/Dropdowns to select internal users/groups to notify.
        *   Checkboxes/Dropdowns to select client contacts/groups to notify.
        *   Optional: Add a custom message for the notification.
    *   **Action:** Marks the report as "Published," sends notifications (in-app and/or email), and makes the PDF accessible.

### **3. Data Model (Supabase/PostgreSQL)**

*   **`reports`** (Main report record)
    *   `id` (UUID, PK)
    *   `project_id` (UUID, FK to `projects.id`)
    *   `name` (TEXT, e.g., "Daily Report - 2024-07-08")
    *   `type` (ENUM: `daily`, `weekly`, `monthly`, `safety`, `financial`, `progress`, `quality`, `custom`)
    *   `status` (ENUM: `draft`, `pending_review`, `published`)
    *   `generated_by` (UUID, FK to `users.id`)
    *   `generated_at` (TIMESTAMP)
    *   `published_at` (TIMESTAMP, nullable)
    *   `pdf_url` (TEXT, URL to the stored PDF in Supabase Storage, nullable)
    *   `summary` (TEXT, nullable - for overall report summary)
    *   `report_period` (TEXT, nullable)

*   **`report_lines`** (Each line item within a report)
    *   `id` (UUID, PK)
    *   `report_id` (UUID, FK to `reports.id`)
    *   `line_number` (INT, for ordering)
    *   `title` (TEXT, e.g., "Foundation Work")
    *   `description` (TEXT)

*   **`report_line_photos`** (Photos associated with each report line)
    *   `id` (UUID, PK)
    *   `report_line_id` (UUID, FK to `report_lines.id`)
    *   `photo_url` (TEXT, URL to the stored image in Supabase Storage)
    *   `caption` (TEXT, nullable)
    *   `uploaded_at` (TIMESTAMP)

*   **`report_shares`** (Records who a report was shared with)
    *   `id` (UUID, PK)
    *   `report_id` (UUID, FK to `reports.id`)
    *   `shared_with_user_id` (UUID, FK to `users.id`, nullable)
    *   `shared_with_client_id` (UUID, FK to `clients.id`, nullable - assuming a client table)
    *   `shared_at` (TIMESTAMP)

### **4. API Endpoints (Next.js API Routes)**

*   **`POST /api/reports`**: Create a new report (initial draft).
*   **`POST /api/reports/:reportId/lines`**: Add a new line to a report.
*   **`PUT /api/reports/lines/:lineId`**: Update a report line.
*   **`POST /api/reports/lines/:lineId/photos`**: Upload photos for a report line.
*   **`GET /api/reports/:reportId`**: Retrieve a full report with all its lines and photos.
*   **`POST /api/reports/:reportId/generate-pdf`**: Trigger PDF generation.
*   **`POST /api/reports/:reportId/publish`**: Publish report and handle notifications/sharing.
*   **`GET /api/projects/:projectId/reports`**: List all reports for a specific project (for the project's "Reports" section).

### **5. PDF Generation Strategy (Refined)**

*   **Server-Side Generation using a dedicated library:**
    *   This will involve using a Node.js PDF generation library (e.g., `pdfkit`, `jsPDF` on the server-side) within a Next.js API route or a dedicated serverless function.
    *   The server-side code will programmatically construct the PDF document by adding text, images, and formatting based on the data retrieved from the `reports` and `report_lines` tables.
    *   **Important Consideration:** This approach is suitable if the report layouts are relatively simple and consistent. If you anticipate highly complex, dynamic, or visually rich layouts (e.g., requiring precise CSS-like styling, complex tables, or charts), programmatically drawing every element can become significantly more complex and time-consuming than rendering HTML to PDF. Ensure your report design aligns with the capabilities of a programmatic PDF library.
*   **Storage:** The generated PDF will be stored in Supabase Storage, and its URL saved in `reports.pdf_url`.

### **6. User Interface (UI) Components**

*   **`ReportCreationPage` (New dedicated page/route, e.g., `/projects/[id]/reports/new`):**
    *   Overall report details form (name, type).
    *   Iterative form for `report_lines` and `report_line_photos`.
    *   Summary list of added lines.
    *   "Save Line & Add Next," "Previous Line," "Review Report" buttons.
*   **`ReportReviewPage` (New dedicated page/route, e.g., `/projects/[id]/reports/[reportId]/review`):**
    *   Displays the full report for review.
    *   "Generate PDF," "Edit Report" buttons.
*   **`ReportPublishModal`:**
    *   Triggered from `ReportReviewPage`.
    *   Allows selection of internal users/clients for notification.
    *   "Publish" button.
*   **`ReportsListTab` (Replaces old `ReportsTab.tsx` in project view):**
    *   Displays a list of reports for the current project.
    *   Columns: Report Name, Type, Status, Generated By, Generated Date, Published Date, Actions (View PDF, Edit (if draft), Share).
    *   "Create New Report" button.
    *   **One-click PDF viewing:** Clicking a "View PDF" button/icon will open the `pdf_url`.

### **7. Notifications**

*   **In-App Notifications:** Triggered upon report publication, notifying selected internal users and clients.
*   **Email Notifications:** For critical report publications, send emails to selected recipients.

### **8. Integration with Project View**

*   The "Reports" tab within the "Project Management Workspace" (`src/app/projects/[id]/page.tsx`) will now render the new `ReportsListTab` component, which will fetch and display real report data.
